<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <script>
        // Redirect standalone patient summary to SPA route
        if (window.location.pathname.includes('Patient summary')) {
            window.location.href = 'index.html#/screening/step4';
        }
    </script>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>OncoGuard AI - Step 4: Summary &amp; AI Analysis</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#137fec", "background-light": "#f6f7f8", "background-dark": "#101922" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100dvh;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1
            }

            100% {
                transform: scale(2);
                opacity: 0
            }
        }

        .pulse-ring {
            animation: pulse-ring 1.5s ease-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .ai-result h3 {
            font-size: 1rem;
            font-weight: 700;
            margin: 1rem 0 0.5rem;
            color: #137fec;
        }

        .ai-result h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0.75rem 0 0.4rem;
        }

        .ai-result ul {
            list-style: disc;
            padding-left: 1.25rem;
            margin: 0.25rem 0;
        }

        .ai-result li {
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: #475569;
        }

        .ai-result p {
            font-size: 0.875rem;
            color: #475569;
            line-height: 1.6;
            margin: 0.25rem 0;
        }

        .ai-result strong {
            color: #1e293b;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
    <script src="js/auth.js"></script>
    <script>requireAuth();</script>

    <!-- Header -->
    <header
        class="sticky top-0 z-10 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-2xl mx-auto flex items-center justify-between p-4">
            <a href="symptom check list.html"
                class="flex items-center gap-2 text-primary hover:underline text-sm font-semibold">
                <span class="material-symbols-outlined text-lg">arrow_back</span> Back
            </a>
            <h1 class="text-lg font-bold tracking-tight">Review &amp; Analyze</h1>
            <button onclick="logout()"
                class="text-xs text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
                <span class="material-symbols-outlined text-sm">logout</span>
            </button>
        </div>
    </header>

    <!-- Progress -->
    <div class="max-w-2xl mx-auto w-full px-4 pt-6 pb-2">
        <div class="flex items-center justify-between text-xs text-slate-400 mb-2">
            <span class="font-bold text-primary">Step 4 of 4 — Summary & AI Analysis</span>
            <span>100%</span>
        </div>
        <div class="flex gap-2">
            <div class="flex-1 h-2 rounded-full bg-primary"></div>
            <div class="flex-1 h-2 rounded-full bg-primary"></div>
            <div class="flex-1 h-2 rounded-full bg-primary"></div>
            <div class="flex-1 h-2 rounded-full bg-primary"></div>
        </div>
    </div>

    <!-- Content -->
    <main class="flex-1 max-w-2xl mx-auto w-full px-4 py-6 space-y-6">

        <!-- Patient Info Card -->
        <div
            class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden fade-in">
            <div class="flex items-center justify-between p-4 bg-primary/5 border-b border-primary/10">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">person</span>
                    <h3 class="text-sm font-bold uppercase tracking-wide">Patient Information</h3>
                </div>
                <a href="screeing step1.html" class="text-primary text-xs font-bold hover:underline">EDIT</a>
            </div>
            <div class="p-4 space-y-2" id="summaryStep1">
                <p class="text-sm text-slate-400 italic">No data found. Please complete Step 1.</p>
            </div>
        </div>

        <!-- Lifestyle Card -->
        <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden fade-in"
            style="animation-delay:0.1s">
            <div class="flex items-center justify-between p-4 bg-primary/5 border-b border-primary/10">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">favorite</span>
                    <h3 class="text-sm font-bold uppercase tracking-wide">Lifestyle Assessment</h3>
                </div>
                <a href="lifestyle Assessment.html" class="text-primary text-xs font-bold hover:underline">EDIT</a>
            </div>
            <div class="p-4 space-y-2" id="summaryStep2">
                <p class="text-sm text-slate-400 italic">No data found. Please complete Step 2.</p>
            </div>
        </div>

        <!-- Symptoms Card -->
        <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden fade-in"
            style="animation-delay:0.2s">
            <div class="flex items-center justify-between p-4 bg-primary/5 border-b border-primary/10">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">checklist</span>
                    <h3 class="text-sm font-bold uppercase tracking-wide">Reported Symptoms</h3>
                </div>
                <a href="symptom check list.html" class="text-primary text-xs font-bold hover:underline">EDIT</a>
            </div>
            <div class="p-4 space-y-2" id="summaryStep3">
                <p class="text-sm text-slate-400 italic">No data found. Please complete Step 3.</p>
            </div>
        </div>

        <!-- AI Analysis Button -->
        <div id="analysisActions" class="fade-in" style="animation-delay:0.3s">
            <div class="p-4 bg-primary/10 rounded-xl border-2 border-dashed border-primary/30 mb-4">
                <div class="flex gap-3">
                    <span class="material-symbols-outlined text-primary">info</span>
                    <p class="text-slate-700 dark:text-slate-300 text-xs leading-relaxed">
                        By running AI analysis, the patient data above will be sent to an AI model for health risk
                        assessment. The analysis is for informational purposes only and does not constitute medical
                        advice.
                    </p>
                </div>
            </div>
            <button id="analyzeBtn" onclick="runAIAnalysis()"
                class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/20 flex items-center justify-center gap-3 transition-all">
                <span class="material-symbols-outlined text-xl">psychology</span>
                Run AI Health Analysis
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <div
                class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-10 text-center">
                <div class="relative inline-flex items-center justify-center mb-4">
                    <div class="absolute w-16 h-16 rounded-full bg-primary/20 pulse-ring"></div>
                    <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-2xl spinner">progress_activity</span>
                    </div>
                </div>
                <h3 class="text-lg font-bold mb-1">Analyzing Patient Data...</h3>
                <p class="text-sm text-slate-500">Our AI is reviewing all submitted information. This may take a few
                    moments.</p>
            </div>
        </div>

        <!-- AI Results -->
        <div id="aiResults" class="hidden">
            <div
                class="bg-white dark:bg-slate-900 rounded-xl border-2 border-primary/30 shadow-lg overflow-hidden fade-in">
                <div
                    class="p-5 bg-gradient-to-r from-primary/10 to-primary/5 border-b border-primary/20 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-xl">psychology</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold">AI Health Analysis</h3>
                        <p class="text-xs text-slate-500">Powered by OncoGuard AI Engine</p>
                    </div>
                </div>
                <div class="p-6 ai-result" id="aiContent">
                    <!-- AI response rendered here -->
                </div>
                <div class="p-4 bg-amber-50 dark:bg-amber-900/10 border-t border-amber-200 dark:border-amber-800">
                    <p class="text-xs text-amber-700 dark:text-amber-400 flex items-start gap-2">
                        <span class="material-symbols-outlined text-sm mt-0.5">warning</span>
                        <span><strong>Disclaimer:</strong> This AI analysis is for informational purposes only. It does
                            not constitute medical diagnosis or advice. Always consult a qualified healthcare
                            professional.</span>
                    </p>
                </div>
            </div>
            <!-- Actions after analysis -->
            <div class="flex gap-4 mt-6">
                <button onclick="window.print()"
                    class="flex-1 py-3 rounded-xl border border-slate-200 dark:border-slate-700 font-semibold text-slate-600 text-center hover:bg-slate-50 transition flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-lg">print</span> Print
                </button>
                <a href="risk prediction dashboard.html"
                    class="flex-[2] py-3 rounded-xl bg-primary text-white font-bold shadow-lg shadow-primary/20 hover:bg-primary/90 transition flex items-center justify-center gap-2 text-center">
                    View Dashboard
                    <span class="material-symbols-outlined text-lg">arrow_forward</span>
                </a>
            </div>
        </div>

        <!-- Footer Notice -->
        <div class="py-6 text-center">
            <p class="text-slate-400 text-[10px] uppercase tracking-wider">
                CONFIDENTIAL MEDICAL RECORD • HIPAA COMPLIANT • ONCOGUARD AI v4.2
            </p>
        </div>
    </main>

    <script>
        // ── Render Summary Cards ────────────────────────────────
        function renderRow(label, value) {
            return `<div class="flex justify-between gap-4 py-1.5 border-b border-slate-50 dark:border-slate-800 last:border-0">
                <span class="text-slate-500 dark:text-slate-400 text-sm">${label}</span>
                <span class="text-sm font-semibold text-right">${value || '—'}</span>
            </div>`;
        }

        function loadSummary() {
            // Step 1
            const s1 = JSON.parse(localStorage.getItem('screening_step1') || 'null');
            if (s1) {
                document.getElementById('summaryStep1').innerHTML =
                    renderRow('Full Name', s1.fullName) +
                    renderRow('Age', s1.age) +
                    renderRow('Gender', s1.gender) +
                    renderRow('Date of Birth', s1.dob) +
                    renderRow('Contact', s1.contactNumber) +
                    renderRow('Email', s1.email) +
                    renderRow('Emergency Contact', s1.emergencyContact);
            }

            // Step 2
            const s2 = JSON.parse(localStorage.getItem('screening_step2') || 'null');
            if (s2) {
                document.getElementById('summaryStep2').innerHTML =
                    renderRow('Smoking', s2.smoking) +
                    renderRow('Alcohol', s2.alcohol + ' drinks/week') +
                    renderRow('Exercise', s2.exercise) +
                    renderRow('Diet', s2.diet) +
                    renderRow('Sleep', s2.sleep + ' hrs/night') +
                    renderRow('Stress Level', s2.stress) +
                    renderRow('Water Intake', s2.water + ' L/day');
            }

            // Step 3
            const s3 = JSON.parse(localStorage.getItem('screening_step3') || 'null');
            if (s3) {
                let html = '';
                if (s3.symptomLabels && s3.symptomLabels.length > 0) {
                    html += '<div class="flex flex-wrap gap-2 mb-2">';
                    s3.symptomLabels.forEach(label => {
                        html += `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs font-semibold">
                            <span class="material-symbols-outlined text-xs">warning</span>${label}</span>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="text-sm text-green-600 font-medium flex items-center gap-1"><span class="material-symbols-outlined text-sm">check_circle</span> No symptoms reported</p>';
                }
                if (s3.otherSymptoms) {
                    html += renderRow('Other Symptoms', s3.otherSymptoms);
                }
                document.getElementById('summaryStep3').innerHTML = html;
            }
        }
        loadSummary();

        // ── Build Prompt ────────────────────────────────────────
        function buildPrompt() {
            const s1 = JSON.parse(localStorage.getItem('screening_step1') || '{}');
            const s2 = JSON.parse(localStorage.getItem('screening_step2') || '{}');
            const s3 = JSON.parse(localStorage.getItem('screening_step3') || '{}');

            return `You are OncoGuard AI, an advanced health screening assistant. Analyze the following patient data and provide a comprehensive health assessment.

PATIENT INFORMATION:
- Name: ${s1.fullName || 'N/A'}
- Age: ${s1.age || 'N/A'}
- Gender: ${s1.gender || 'N/A'}
- Date of Birth: ${s1.dob || 'N/A'}

LIFESTYLE FACTORS:
- Smoking Status: ${s2.smoking || 'N/A'}
- Alcohol Consumption: ${s2.alcohol || '0'} drinks per week
- Exercise Frequency: ${s2.exercise || 'N/A'}
- Diet Type: ${s2.diet || 'N/A'}
- Sleep: ${s2.sleep || 'N/A'} hours per night
- Stress Level: ${s2.stress || 'N/A'}
- Water Intake: ${s2.water || 'N/A'} liters per day

REPORTED SYMPTOMS:
${s3.symptomLabels && s3.symptomLabels.length > 0 ? s3.symptomLabels.map(s => '- ' + s).join('\n') : '- None reported'}
${s3.otherSymptoms ? 'Other: ' + s3.otherSymptoms : ''}

Please provide your analysis in the following format using HTML formatting:
1. <h3>Overall Health Assessment</h3> - Brief overview
2. <h3>Potential Risk Factors</h3> - List key risks based on the data
3. <h3>Lifestyle Recommendations</h3> - Specific actionable suggestions
4. <h3>Symptoms to Monitor</h3> - Which symptoms need attention
5. <h3>Suggested Next Steps</h3> - Recommended medical follow-ups

Be specific, professional, and evidence-based. Use <ul><li> for lists. Use <strong> for emphasis.`;
        }

        // ── AI Analysis ─────────────────────────────────────────
        async function runAIAnalysis() {
            const btn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loadingState');
            const results = document.getElementById('aiResults');
            const actions = document.getElementById('analysisActions');

            // Show loading
            actions.classList.add('hidden');
            loading.classList.remove('hidden');
            results.classList.add('hidden');

            const prompt = buildPrompt();

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'YOUR_API_KEY_HERE',
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{ role: 'user', content: prompt }],
                    }),
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const text = data.content?.[0]?.text || 'No response received.';
                displayResults(text);
            } catch (err) {
                console.warn('API call failed, using fallback analysis:', err.message);
                displayResults(generateFallbackAnalysis());
            }
        }

        function displayResults(html) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('aiResults').classList.remove('hidden');
            document.getElementById('aiContent').innerHTML = html;
        }

        // ── Fallback Analysis ───────────────────────────────────
        function generateFallbackAnalysis() {
            const s1 = JSON.parse(localStorage.getItem('screening_step1') || '{}');
            const s2 = JSON.parse(localStorage.getItem('screening_step2') || '{}');
            const s3 = JSON.parse(localStorage.getItem('screening_step3') || '{}');
            const symptoms = s3.symptomLabels || [];
            const age = parseInt(s1.age) || 30;

            let risks = [];
            let recs = [];
            let monitor = [];

            // Age-based
            if (age > 50) risks.push('Age over 50 increases risk for cardiovascular disease, diabetes, and certain cancers');
            if (age > 40) recs.push('Schedule annual comprehensive health checkup');

            // Smoking
            if (s2.smoking === 'Daily smoker') { risks.push('Daily smoking significantly increases risk for lung cancer, COPD, and heart disease'); recs.push('Strongly consider smoking cessation programs — consult your physician about nicotine replacement therapy'); }
            else if (s2.smoking === 'Occasional smoker') { risks.push('Even occasional smoking increases cardiovascular risk'); recs.push('Work toward complete cessation of tobacco use'); }
            else if (s2.smoking === 'Former smoker') { recs.push('Continue tobacco abstinence — lung cancer risk decreases significantly after 10+ years'); }

            // Alcohol
            const alc = parseInt(s2.alcohol) || 0;
            if (alc > 14) { risks.push('Heavy alcohol consumption (>' + alc + ' drinks/week) increases liver disease and cancer risk'); recs.push('Reduce alcohol intake to below 7 drinks/week'); }
            else if (alc > 7) { risks.push('Moderate-to-high alcohol consumption may affect liver health'); recs.push('Consider reducing alcohol intake to below 7 drinks per week'); }

            // Exercise
            if (s2.exercise && s2.exercise.includes('Rarely')) { risks.push('Sedentary lifestyle increases risk for obesity, diabetes, and cardiovascular disease'); recs.push('Aim for at least 150 minutes of moderate aerobic activity per week'); }

            // Sleep
            const sleep = parseFloat(s2.sleep) || 7;
            if (sleep < 6) { risks.push('Insufficient sleep (<6 hours) is associated with metabolic disorders and weakened immunity'); recs.push('Prioritize 7-9 hours of sleep per night; consider sleep hygiene practices'); }
            if (sleep > 9) { recs.push('Excessive sleep may indicate underlying health issues — discuss with your doctor'); }

            // Stress
            if (s2.stress === 'Very High' || s2.stress === 'High') { risks.push('Chronic high stress elevates cortisol, affecting immune function and cardiovascular health'); recs.push('Incorporate stress management: meditation, deep breathing, or professional counseling'); }

            // Water
            const water = parseFloat(s2.water) || 2;
            if (water < 1.5) { recs.push('Increase daily water intake to at least 2 liters for optimal hydration'); }

            // Symptoms
            if (symptoms.includes('Chest Pain')) { monitor.push('<strong>Chest Pain</strong> — Seek immediate medical evaluation to rule out cardiac causes'); }
            if (symptoms.includes('Shortness of Breath')) { monitor.push('<strong>Shortness of Breath</strong> — May indicate respiratory or cardiac conditions; requires clinical assessment'); }
            if (symptoms.includes('Fatigue')) { monitor.push('<strong>Persistent Fatigue</strong> — Could indicate anemia, thyroid dysfunction, or chronic fatigue syndrome'); }
            if (symptoms.includes('Headache')) { monitor.push('<strong>Frequent Headaches</strong> — Track frequency and triggers; may require neurological evaluation if persistent'); }
            if (symptoms.includes('Weight Changes')) { monitor.push('<strong>Unexplained Weight Changes</strong> — May indicate thyroid issues, diabetes, or other metabolic disorders'); }
            if (symptoms.includes('Fever')) { monitor.push('<strong>Recurring Fever</strong> — May indicate infection or inflammatory conditions'); }
            if (symptoms.includes('Joint Pain')) { monitor.push('<strong>Joint Pain</strong> — Consider evaluation for arthritis or autoimmune conditions'); }
            if (symptoms.includes('Mood Changes')) { monitor.push('<strong>Mood Changes</strong> — Consider mental health screening; stress and mood are linked to physical health'); }
            if (symptoms.includes('Dizziness')) { monitor.push('<strong>Dizziness</strong> — Could relate to blood pressure, inner ear issues, or medication side effects'); }
            if (symptoms.includes('Nausea')) { monitor.push('<strong>Nausea</strong> — Monitor frequency; may require GI evaluation if persistent'); }

            if (risks.length === 0) risks.push('No significant risk factors identified based on provided data');
            if (recs.length === 0) recs.push('Continue maintaining your current healthy lifestyle');
            if (monitor.length === 0) monitor.push('No concerning symptoms reported — continue regular health monitoring');

            return `
                <h3>Overall Health Assessment</h3>
                <p>Based on the screening data for <strong>${s1.fullName || 'the patient'}</strong> (age ${age}, ${s1.gender || 'N/A'}), 
                this analysis evaluates lifestyle factors and reported symptoms to identify potential health considerations. 
                ${symptoms.length > 0 ? `The patient reports <strong>${symptoms.length} symptom(s)</strong> that warrant attention.` : 'No active symptoms were reported, which is a positive indicator.'}</p>

                <h3>Potential Risk Factors</h3>
                <ul>${risks.map(r => `<li>${r}</li>`).join('')}</ul>

                <h3>Lifestyle Recommendations</h3>
                <ul>${recs.map(r => `<li>${r}</li>`).join('')}</ul>

                <h3>Symptoms to Monitor</h3>
                <ul>${monitor.map(m => `<li>${m}</li>`).join('')}</ul>

                <h3>Suggested Next Steps</h3>
                <ul>
                    <li><strong>Primary Care Visit:</strong> Schedule a comprehensive checkup within the next 2-4 weeks</li>
                    <li><strong>Blood Work:</strong> Complete metabolic panel, CBC, and lipid panel recommended</li>
                    ${age > 45 ? '<li><strong>Cancer Screening:</strong> Discuss age-appropriate cancer screening with your physician</li>' : ''}
                    ${symptoms.length > 0 ? '<li><strong>Symptom Follow-up:</strong> Discuss reported symptoms in detail with your healthcare provider</li>' : ''}
                    <li><strong>Follow-up:</strong> Re-screen in 6 months or sooner if symptoms worsen</li>
                </ul>
            `;
        }
    </script>
</body>

</html>